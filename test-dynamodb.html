<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DynamoDB Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #1C1C1E;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .test-button:disabled {
            background: #333;
            cursor: not-allowed;
        }
        .result {
            background: #2C2C2E;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #30D158;
        }
        .error {
            color: #FF453A;
        }
        .warning {
            color: #FF9F0A;
        }
        .info {
            color: #64D2FF;
        }
        h1, h2 {
            color: #fff;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.success {
            background: rgba(48, 209, 88, 0.2);
            color: #30D158;
        }
        .status.error {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
        }
        .status.pending {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Test DynamoDB Integration</h1>
        <p>Ten panel testuje integrację z AWS DynamoDB i migrację danych z localStorage.</p>

        <div class="test-section">
            <h2>📊 Status Połączenia</h2>
            <button class="test-button" onclick="testConnection()">Test Połączenia DynamoDB</button>
            <button class="test-button" onclick="checkTables()">Sprawdź Tabele</button>
            <div id="connectionResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>👤 Test Operacji na Użytkownikach</h2>
            <button class="test-button" onclick="testUserOperations()">Test CRUD Użytkowników</button>
            <button class="test-button" onclick="testSessionOperations()">Test CRUD Sesji</button>
            <div id="userResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>🔄 Test Migracji Danych</h2>
            <button class="test-button" onclick="setupTestData()">Przygotuj Dane Testowe</button>
            <button class="test-button" onclick="runMigration()">Uruchom Migrację</button>
            <button class="test-button" onclick="verifyMigration()">Sprawdź Migrację</button>
            <div id="migrationResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>💰 Monitoring Kosztów</h2>
            <button class="test-button" onclick="estimateCosts()">Oszacuj Koszty</button>
            <button class="test-button" onclick="showUsageStats()">Statystyki Użycia</button>
            <div id="costResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>🧹 Narzędzia</h2>
            <button class="test-button" onclick="clearLocalStorage()">Wyczyść localStorage</button>
            <button class="test-button" onclick="clearDynamoDB()">Wyczyść DynamoDB (TEST)</button>
            <button class="test-button" onclick="resetMigration()">Reset Migracji</button>
            <div id="toolsResult" class="result"></div>
        </div>
    </div>

    <!-- Import modułów -->
    <script type="module">
        import { storageManager } from './src/js/storage-manager-browser.js';

        // Udostępnij globalnie dla testów
        window.storageManager = storageManager;

        // Test połączenia przy ładowaniu strony
        document.addEventListener('DOMContentLoaded', async () => {
            log('connectionResult', '🚀 Inicjalizacja testów...', 'info');
            
            try {
                const isAvailable = await storageManager.testConnection();
                if (isAvailable) {
                    log('connectionResult', '✅ DynamoDB dostępne', 'success');
                } else {
                    log('connectionResult', '⚠️ DynamoDB niedostępne - używam localStorage', 'warning');
                }
            } catch (error) {
                log('connectionResult', `❌ Błąd połączenia: ${error.message}`, 'error');
            }
        });

        // Funkcje testowe
        window.testConnection = async function() {
            log('connectionResult', '🔍 Testowanie połączenia...', 'info');
            
            try {
                const isAvailable = await storageManager.testConnection();
                
                if (isAvailable) {
                    log('connectionResult', '✅ Połączenie z DynamoDB udane!', 'success');
                    
                    // Test podstawowych operacji
                    await storageManager.setItem('test_key', 'test_value');
                    const value = await storageManager.getItem('test_key');
                    
                    if (value === 'test_value') {
                        log('connectionResult', '✅ Test zapisu/odczytu udany', 'success');
                    } else {
                        log('connectionResult', '❌ Test zapisu/odczytu nieudany', 'error');
                    }
                    
                    await storageManager.removeItem('test_key');
                    log('connectionResult', '✅ Test usuwania udany', 'success');
                    
                } else {
                    log('connectionResult', '⚠️ DynamoDB niedostępne - fallback na localStorage', 'warning');
                }
            } catch (error) {
                log('connectionResult', `❌ Błąd: ${error.message}`, 'error');
            }
        };

        window.checkTables = async function() {
            log('connectionResult', '📋 Sprawdzanie tabel DynamoDB...', 'info');
            
            try {
                // Sprawdź czy tabele istnieją poprzez próbę zapisu
                await storageManager.setUser('test-user-123', {
                    id: 'test-user-123',
                    email: 'test@example.com',
                    name: 'Test User'
                });
                
                log('connectionResult', '✅ Tabela ecm-digital-users dostępna', 'success');
                
                await storageManager.setSession('test-session-123', {
                    sessionId: 'test-session-123',
                    userId: 'test-user-123',
                    createdAt: new Date().toISOString()
                });
                
                log('connectionResult', '✅ Tabela ecm-digital-sessions dostępna', 'success');
                
                // Cleanup
                await storageManager.removeUser('test-user-123');
                await storageManager.removeSession('test-session-123');
                
            } catch (error) {
                log('connectionResult', `❌ Błąd sprawdzania tabel: ${error.message}`, 'error');
            }
        };

        window.testUserOperations = async function() {
            log('userResult', '👤 Testowanie operacji na użytkownikach...', 'info');
            
            try {
                const testUser = {
                    userId: 'test-user-' + Date.now(),
                    email: 'test@ecm-digital.com',
                    name: 'Test User',
                    role: 'client',
                    createdAt: new Date().toISOString()
                };
                
                // CREATE
                await storageManager.setUser(testUser);
                log('userResult', `✅ Utworzono użytkownika: ${testUser.userId}`, 'success');
                
                // READ
                const retrievedUser = await storageManager.getUser(testUser.userId);
                if (retrievedUser && retrievedUser.email === testUser.email) {
                    log('userResult', '✅ Odczyt użytkownika udany', 'success');
                } else {
                    log('userResult', '❌ Błąd odczytu użytkownika', 'error');
                }
                
                // UPDATE
                testUser.name = 'Updated Test User';
                await storageManager.setUser(testUser);
                const updatedUser = await storageManager.getUser(testUser.userId);
                if (updatedUser && updatedUser.name === 'Updated Test User') {
                    log('userResult', '✅ Aktualizacja użytkownika udana', 'success');
                } else {
                    log('userResult', '❌ Błąd aktualizacji użytkownika', 'error');
                }
                
                // DELETE
                await storageManager.removeItem(`user_${testUser.userId}`);
                const deletedUser = await storageManager.getUser(testUser.userId);
                if (!deletedUser) {
                    log('userResult', '✅ Usunięcie użytkownika udane', 'success');
                } else {
                    log('userResult', '❌ Błąd usuwania użytkownika', 'error');
                }
                
            } catch (error) {
                log('userResult', `❌ Błąd testów użytkowników: ${error.message}`, 'error');
            }
        };

        window.testSessionOperations = async function() {
            log('userResult', '🔐 Testowanie operacji na sesjach...', 'info');
            
            try {
                const testSession = {
                    sessionId: 'test-session-' + Date.now(),
                    userId: 'test-user-123',
                    token: 'test-token-' + Math.random(),
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };
                
                // CREATE
                await storageManager.setSession(testSession);
                log('userResult', `✅ Utworzono sesję: ${testSession.sessionId}`, 'success');
                
                // READ
                const retrievedSession = await storageManager.getSession(testSession.sessionId);
                if (retrievedSession && retrievedSession.userId === testSession.userId) {
                    log('userResult', '✅ Odczyt sesji udany', 'success');
                } else {
                    log('userResult', '❌ Błąd odczytu sesji', 'error');
                }
                
                // DELETE
                await storageManager.removeItem(`session_${testSession.sessionId}`);
                const deletedSession = await storageManager.getSession(testSession.sessionId);
                if (!deletedSession) {
                    log('userResult', '✅ Usunięcie sesji udane', 'success');
                } else {
                    log('userResult', '❌ Błąd usuwania sesji', 'error');
                }
                
            } catch (error) {
                log('userResult', `❌ Błąd testów sesji: ${error.message}`, 'error');
            }
        };

        window.setupTestData = function() {
            log('migrationResult', '📦 Przygotowywanie danych testowych...', 'info');
            
            // Symuluj dane w localStorage
            localStorage.setItem('ecm_user', JSON.stringify({
                id: 'user-123',
                email: 'test@ecm-digital.com',
                name: 'Test User',
                role: 'client'
            }));
            
            localStorage.setItem('ecm_token', 'test-token-123');
            localStorage.setItem('confirmationEmail', 'test@ecm-digital.com');
            localStorage.setItem('language', 'pl');
            localStorage.setItem('hubspot_tracking', 'enabled');
            
            log('migrationResult', '✅ Dane testowe przygotowane w localStorage', 'success');
            log('migrationResult', `Klucze: ${Object.keys(localStorage).filter(k => k.startsWith('ecm_') || k.includes('test')).join(', ')}`, 'info');
        };

        window.runMigration = async function() {
            log('migrationResult', '🔄 Symulacja migracji danych...', 'info');
            
            try {
                // Pobierz wszystkie dane ECM z localStorage
                const allData = storageManager.exportAllData();
                log('migrationResult', `📦 Znaleziono ${Object.keys(allData).length} elementów do migracji`, 'info');
                
                // Symuluj migrację do DynamoDB (w rzeczywistości pozostanie w localStorage)
                let migrated = 0;
                for (const [key, value] of Object.entries(allData)) {
                    if (key.startsWith('ecm_')) {
                        migrated++;
                        log('migrationResult', `✅ Zmigrowano: ${key}`, 'info');
                    }
                }
                
                // Ustaw flagę migracji
                await storageManager.setItem('migration_completed', true);
                
                log('migrationResult', `✅ Migracja zakończona! Zmigrowano ${migrated} elementów`, 'success');
                
            } catch (error) {
                log('migrationResult', `❌ Błąd migracji: ${error.message}`, 'error');
            }
        };

        window.verifyMigration = async function() {
            log('migrationResult', '🔍 Weryfikacja migracji...', 'info');
            
            try {
                const token = await storageManager.getItem('ecm_token');
                const language = await storageManager.getItem('language');
                const migrationFlag = await storageManager.getItem('migration_completed');
                
                log('migrationResult', `Token: ${token ? '✅ Znaleziony' : '❌ Brak'}`, token ? 'success' : 'error');
                log('migrationResult', `Język: ${language || 'Nie ustawiony'}`, language ? 'success' : 'warning');
                log('migrationResult', `Flaga migracji: ${migrationFlag ? '✅ Ustawiona' : '❌ Brak'}`, migrationFlag ? 'success' : 'error');
                
                // Sprawdź localStorage
                const localStorageKeys = Object.keys(localStorage).filter(k => k.startsWith('ecm_'));
                log('migrationResult', `Pozostałe klucze w localStorage: ${localStorageKeys.length > 0 ? localStorageKeys.join(', ') : 'Brak'}`, localStorageKeys.length === 0 ? 'success' : 'warning');
                
            } catch (error) {
                log('migrationResult', `❌ Błąd weryfikacji: ${error.message}`, 'error');
            }
        };

        window.estimateCosts = function() {
            log('costResult', '💰 Szacowanie kosztów DynamoDB...', 'info');
            
            const estimatedOperations = {
                reads: 1000,  // miesięcznie
                writes: 500,  // miesięcznie
                storage: 1    // GB
            };
            
            // Ceny AWS DynamoDB (przybliżone, region us-east-1)
            const pricing = {
                readUnit: 0.25 / 1000000,  // $0.25 za milion RCU
                writeUnit: 1.25 / 1000000, // $1.25 za milion WCU
                storage: 0.25              // $0.25 za GB miesięcznie
            };
            
            const monthlyCost = 
                (estimatedOperations.reads * pricing.readUnit) +
                (estimatedOperations.writes * pricing.writeUnit) +
                (estimatedOperations.storage * pricing.storage);
            
            log('costResult', `📊 Szacowane koszty miesięczne:`, 'info');
            log('costResult', `• Odczyty (${estimatedOperations.reads}): $${(estimatedOperations.reads * pricing.readUnit).toFixed(4)}`, 'info');
            log('costResult', `• Zapisy (${estimatedOperations.writes}): $${(estimatedOperations.writes * pricing.writeUnit).toFixed(4)}`, 'info');
            log('costResult', `• Przechowywanie (${estimatedOperations.storage}GB): $${(estimatedOperations.storage * pricing.storage).toFixed(2)}`, 'info');
            log('costResult', `💰 RAZEM: ~$${monthlyCost.toFixed(4)} miesięcznie`, 'success');
            log('costResult', `💡 Dla małych aplikacji koszt będzie praktycznie zerowy dzięki Free Tier`, 'info');
        };

        window.showUsageStats = function() {
            log('costResult', '📈 Statystyki użycia...', 'info');
            
            // Symulowane statystyki
            const stats = {
                totalUsers: Math.floor(Math.random() * 100) + 10,
                activeSessions: Math.floor(Math.random() * 20) + 1,
                dailyOperations: Math.floor(Math.random() * 500) + 50,
                storageUsed: (Math.random() * 0.1).toFixed(3) // GB
            };
            
            log('costResult', `👥 Użytkownicy: ${stats.totalUsers}`, 'info');
            log('costResult', `🔐 Aktywne sesje: ${stats.activeSessions}`, 'info');
            log('costResult', `📊 Operacje dziennie: ${stats.dailyOperations}`, 'info');
            log('costResult', `💾 Wykorzystane miejsce: ${stats.storageUsed} GB`, 'info');
            
            // Sprawdź czy jesteśmy w Free Tier
            const monthlyOps = stats.dailyOperations * 30;
            const freetierLimit = 25000000; // 25M operacji miesięcznie
            
            if (monthlyOps < freetierLimit) {
                log('costResult', `✅ Miesięczne operacje (${monthlyOps}) mieszczą się w Free Tier`, 'success');
            } else {
                log('costResult', `⚠️ Miesięczne operacje (${monthlyOps}) przekraczają Free Tier`, 'warning');
            }
        };

        window.clearLocalStorage = function() {
            log('toolsResult', '🧹 Czyszczenie localStorage...', 'info');
            
            const keysToRemove = Object.keys(localStorage).filter(key => 
                key.startsWith('ecm_') || 
                key.startsWith('hubspot_') || 
                key.startsWith('auth_') ||
                key === 'confirmationEmail' ||
                key === 'language'
            );
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            log('toolsResult', `✅ Usunięto ${keysToRemove.length} kluczy z localStorage`, 'success');
            log('toolsResult', `Usunięte klucze: ${keysToRemove.join(', ')}`, 'info');
        };

        window.clearDynamoDB = async function() {
            log('toolsResult', '🗑️ Czyszczenie danych testowych z DynamoDB...', 'warning');
            
            try {
                // Usuń tylko dane testowe
                const testKeys = ['test_key', 'ecm_token', 'language', 'confirmationEmail', 'migration_completed'];
                
                for (const key of testKeys) {
                    await storageManager.removeItem(key);
                }
                
                log('toolsResult', '✅ Dane testowe usunięte z DynamoDB', 'success');
                
            } catch (error) {
                log('toolsResult', `❌ Błąd czyszczenia DynamoDB: ${error.message}`, 'error');
            }
        };

        window.resetMigration = async function() {
            log('toolsResult', '🔄 Resetowanie stanu migracji...', 'info');
            
            try {
                await storageManager.removeItem('migration_completed');
                log('toolsResult', '✅ Flaga migracji usunięta', 'success');
                log('toolsResult', '💡 Migracja zostanie uruchomiona ponownie przy następnym ładowaniu strony', 'info');
                
            } catch (error) {
                log('toolsResult', `❌ Błąd resetowania: ${error.message}`, 'error');
            }
        };

        // Funkcja pomocnicza do logowania
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : 
                              type === 'error' ? 'error' : 
                              type === 'warning' ? 'warning' : 'info';
            
            const logEntry = `[${timestamp}] ${message}`;
            
            if (element.textContent) {
                element.textContent += '\n' + logEntry;
            } else {
                element.textContent = logEntry;
            }
            
            element.className = `result ${colorClass}`;
            element.scrollTop = element.scrollHeight;
        }
    </script>
</body>
</html>